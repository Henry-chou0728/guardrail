# 【技術報告】NeMo Guardrails + LangChain 金融 RAG 系統

本系統是一個結合了 **NeMo Guardrails** 與 **LangChain** 的檢索增強生成 (RAG) 解決方案。專為金融問答場景設計，具備「安全護欄」與「外部知識庫檢索」雙重功能。



---

## 一、 核心功能說明

### 1. 向量資料庫連線 (ChromaDB)
系統初始化時會自動載入位於 `./chroma_db` 的本地資料庫，用於存放預先向量化的金融文檔片段。
* **Embedding 模型**: 使用 OpenAI 的 `text-embedding-3-small`，確保高效且精準的語義向量化。

### 2. 自定義 Action 邏輯 (Custom Actions)
程式定義了兩個核心異步函式並註冊至 Guardrails 引擎中：

* **`retrieve_knowledge` (檢索)**：
    * 計算使用者問題與資料庫文檔的相似度（距離分數）。
    * **相關性閥值**：設定為 `score < 1.8`。Chroma 距離分數越小代表相關性越高，僅篩選高相關資訊以過濾雜訊。
* **`generate_answer` (生成)**：
    * **有條件生成**：優先根據檢索到的 `Context` 回答。
    * **動態切換**：若檢索不到相關資訊（例如：打招呼或通用常識），系統會切換至 LLM 內建知識庫，確保對話自然不生硬。

### 3. NeMo Guardrails 安全護欄
透過 `LLMRails(config)` 載入設定，對話流程由外部的 `.co` (Colang) 文件定義。
* **流程控制**：控制 LLM 觸發檢索的時機。
* **安全性**：可預設規則拒絕回答敏感議題或偏離金融領域的問題。

---

## 二、 使用說明指南

### 1. 準備工作
執行前請確保以下環境配置完整：
* **環境變數**：在 `.env` 檔案中設定 `OPENAI_API_KEY`。
* **設定目錄**：必須存在 `./config` 資料夾，內容應包含：
    * `config.yml`: 定義模型參數與路徑。
    * `*.co`: 定義 Colang 對話流程（例如：當 User 提問，呼叫 `retrieve_knowledge`）。
* **向量資料庫**：確保 `./chroma_db` 已存在且內含索引資料。

### 2. 執行步驟
1.  **啟動系統**：執行 Python 腳本，系統將連接資料庫並加載安全護欄規則。
2.  **交互模式**：
    * **專業諮詢**：輸入如「公司 A 的財報表現如何？」，系統將執行 RAG 檢索。
    * **一般對話**：輸入如「你好」或「解釋什麼是複利」，系統將直接由 LLM 回答。
3.  **退出程式**：輸入 `exit` 或 `quit` 關閉系統。

---

## 三、 技術注意事項與建議

| 項目 | 說明與建議 |
| :--- | :--- |
| **分數閥值** | 若發現系統頻繁出現「找不到相關數據」，建議適度調大 `1.8` 這個數值。 |
| **Action 註冊** | 若在 `.co` 中新增了動作，必須在 Python 的 `main()` 中使用 `rails.register_action` 完成註冊。 |
| **幻覺防範** | 結合 GPT-4o 的強大理解力與 Guardrails 的流程限制，能極大程度避免 AI 編造金融數據。 |

---

## 四、 系統邏輯流程圖



1. **User Input** -> 2. **Guardrails Check** -> 3. **Retrieve Action** -> 4. **Context Filter** -> 5. **LLM Generation** -> 6. **Response**
